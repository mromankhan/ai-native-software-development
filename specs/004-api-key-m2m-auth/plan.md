# Implementation Plan: API Key M2M Authentication

**Branch**: `004-api-key-m2m-auth` | **Date**: 2024-12-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-api-key-m2m-auth/spec.md`

## Summary

Enable Machine-to-Machine (M2M) authentication for Panaversity SSO using Better Auth's API Key plugin. Implementation includes:
1. Enabling the Better Auth API Key plugin with secure defaults
2. Database schema migration for the `api_key` table
3. Admin dashboard page for service key management at `/admin/service-keys`
4. Comprehensive test coverage for API key operations

## Technical Context

**Language/Version**: TypeScript 5.6, Node.js 18+
**Primary Dependencies**: Better Auth 1.4.4, Next.js 15.5.7, Drizzle ORM 0.36
**Storage**: Neon Postgres (existing), api_key table (new)
**Testing**: Custom test scripts (existing pattern), Playwright for E2E
**Target Platform**: Vercel/Cloud Run deployment
**Project Type**: Next.js App Router monolith
**Performance Goals**: <100ms API key verification (p95), <500ms key creation
**Constraints**: Admin-only access, argon2id hashing (Better Auth default), rate limiting
**Scale/Scope**: 100k users, ~1000 API keys initially

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **1. Defense in Depth** | ✅ PASS | Multiple layers: session auth → admin role → hashed keys → rate limiting |
| **2. Least Privilege** | ✅ PASS | Admin-only key management, keys tied to creating user |
| **3. Fail Secure** | ✅ PASS | Invalid/expired keys return 401, never grant access |
| **4. No Secrets in Client** | ✅ PASS | Keys server-side only, shown once at creation |
| **5. Standards Compliance** | ✅ PASS | Using Better Auth standard API Key plugin |
| **6. Secure Defaults** | ✅ PASS | Hashing enabled by default, rate limiting on |
| **7. Audit Everything** | ✅ PASS | lastUsed tracking, creation/deletion logged |
| **8. Token Hygiene** | ✅ PASS | Expiration support, revocation immediate |

**All gates pass. Proceeding with implementation.**

## Project Structure

### Documentation (this feature)

```text
specs/004-api-key-m2m-auth/
├── spec.md              # Feature specification
├── plan.md              # This file
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task breakdown (generated by /sp.tasks)
```

### Source Code (repository root)

```text
# Server-side (Better Auth configuration)
src/lib/
├── auth.ts              # ADD: apiKey plugin configuration
└── auth-client.ts       # ADD: apiKeyClient plugin

# Database schema
auth-schema.ts           # ADD: apiKey table definition

# Admin Dashboard
src/app/admin/
├── layout.tsx           # MODIFY: Add "Service Keys" nav link
└── service-keys/
    ├── page.tsx         # NEW: Service keys list page
    └── components/
        ├── api-key-list.tsx          # NEW: Keys table component
        ├── create-key-dialog.tsx     # NEW: Key creation modal
        ├── key-display-dialog.tsx    # NEW: Show key once dialog
        ├── revoke-key-dialog.tsx     # NEW: Revoke confirmation
        └── delete-key-dialog.tsx     # NEW: Delete confirmation

# shadcn/ui components (install required)
src/components/ui/
├── button.tsx           # NEW: shadcn button
├── dialog.tsx           # NEW: shadcn dialog
├── input.tsx            # NEW: shadcn input
├── table.tsx            # NEW: shadcn table
├── badge.tsx            # NEW: shadcn badge
├── alert.tsx            # NEW: shadcn alert
└── card.tsx             # NEW: shadcn card

# Tests
tests/
├── test-api-key.js      # NEW: API key endpoint tests
└── test-api-key-e2e.js  # NEW: End-to-end key management tests
```

**Structure Decision**: Follows existing Next.js App Router pattern. Admin page at `/admin/service-keys` matches existing `/admin/users` and `/admin/clients` patterns.

## Implementation Phases

### Phase 1: Backend - Better Auth API Key Plugin

**Goal**: Enable API Key endpoints without UI

**Steps**:
1. Add `apiKey` import to `src/lib/auth.ts`
2. Configure plugin with secure defaults:
   - `enableMetadata: true`
   - `rateLimit: { enabled: true, timeWindow: 60000, maxRequests: 100 }`
   - No `disableKeyHashing` (keep hashing enabled)
3. Add `apiKeyClient` to `src/lib/auth-client.ts`
4. Add `api_key` table to `auth-schema.ts` with all required fields
5. Add rate limit rules in `customRules` for API key endpoints
6. Generate and push database migration

**Endpoints Enabled**:
- `POST /api/auth/api-key/create` - Create key (requires session)
- `POST /api/auth/api-key/verify` - Verify key (public)
- `POST /api/auth/api-key/delete` - Delete key (requires session)
- `GET /api/auth/api-key/list` - List keys (requires session)
- `POST /api/auth/api-key/update` - Update key (requires session)

**Validation**:
- [ ] TypeScript compiles without errors
- [ ] Dev server starts successfully
- [ ] Database migration applies cleanly
- [ ] `curl` test: create key returns key value
- [ ] `curl` test: verify key returns valid: true
- [ ] `curl` test: list keys returns array

### Phase 2: UI Components - shadcn/ui Setup

**Goal**: Install shadcn/ui and create base components

**Steps**:
1. Initialize shadcn/ui: `npx shadcn@latest init`
   - Style: default
   - Base color: slate (matches existing gray theme)
   - CSS variables: yes
2. Install required components:
   ```bash
   npx shadcn@latest add button dialog input table badge alert card
   ```
3. Verify components work with existing Tailwind config
4. Update `tailwind.config.js` if needed for shadcn compatibility

**Validation**:
- [ ] shadcn components render correctly
- [ ] No style conflicts with existing admin pages
- [ ] Dark mode compatible (if existing)

### Phase 3: Admin Dashboard - Service Keys Page

**Goal**: Full CRUD UI for API keys

**Components**:

#### 3.1 Service Keys List Page (`/admin/service-keys/page.tsx`)
- Fetch all API keys using `authClient.apiKey.list()`
- Display in table with columns: Name, Prefix, Status, Created, Last Used, Actions
- "Create New Key" button at top
- Loading and empty states

#### 3.2 API Key List Component (`api-key-list.tsx`)
- shadcn Table with sortable columns
- Status badge (Active/Revoked/Expired)
- Actions dropdown: View, Revoke, Delete
- Pagination if >20 keys

#### 3.3 Create Key Dialog (`create-key-dialog.tsx`)
- Form fields: Name (required), Expiration (optional dropdown)
- Expiration options: Never, 30 days, 90 days, 1 year
- Submit calls `authClient.apiKey.create()`
- On success, show KeyDisplayDialog

#### 3.4 Key Display Dialog (`key-display-dialog.tsx`)
- Shows full API key ONCE
- Warning banner: "This key will only be shown once"
- Copy to clipboard button
- "I've saved this key" confirmation before close
- Cannot close without confirmation

#### 3.5 Revoke Key Dialog (`revoke-key-dialog.tsx`)
- Confirmation dialog with key name
- Warning about immediate effect
- Calls `authClient.apiKey.update({ keyId, enabled: false })`

#### 3.6 Delete Key Dialog (`delete-key-dialog.tsx`)
- Confirmation dialog with key name
- Warning about permanent deletion
- Requires typing key name to confirm
- Calls `authClient.apiKey.delete({ keyId })`

**Validation**:
- [ ] Can create new key and see it displayed once
- [ ] Can copy key to clipboard
- [ ] Keys appear in list immediately after creation
- [ ] Can revoke key and see status change
- [ ] Can delete key and see it removed from list
- [ ] Last Used updates after verification

### Phase 4: Navigation Update

**Goal**: Add Service Keys link to admin navigation

**Steps**:
1. Update `src/app/admin/layout.tsx`:
   - Add nav link for "Service Keys" pointing to `/admin/service-keys`
   - Position after "OAuth Clients" in nav order
2. Ensure consistent styling with existing nav items

**Validation**:
- [ ] Service Keys link appears in admin nav
- [ ] Link navigates to correct page
- [ ] Active state shows correctly when on page

### Phase 5: Testing

**Goal**: Comprehensive test coverage

#### 5.1 API Tests (`tests/test-api-key.js`)
```javascript
// Test cases:
// 1. Create key - success with name
// 2. Create key - fail without auth
// 3. Create key - fail with empty name
// 4. Verify key - success with valid key
// 5. Verify key - fail with invalid key
// 6. Verify key - fail with revoked key
// 7. Verify key - fail with expired key
// 8. List keys - returns array
// 9. Delete key - removes from list
// 10. Rate limit - returns 429 after limit
```

#### 5.2 E2E Tests (`tests/test-api-key-e2e.js`)
```javascript
// Test cases:
// 1. Admin can access service keys page
// 2. Non-admin cannot access service keys page
// 3. Can create key via UI
// 4. Key display shows once warning
// 5. Can copy key to clipboard
// 6. Can revoke key via UI
// 7. Can delete key via UI
// 8. Last used updates after verification
```

**Validation**:
- [ ] All API tests pass
- [ ] All E2E tests pass
- [ ] Test coverage for edge cases
- [ ] Tests run in CI pipeline

### Phase 6: Documentation

**Goal**: Update integration docs for API key usage

**Steps**:
1. Update `docs/integration-guide.md` with API key section
2. Document header format: `x-api-key: <key>`
3. Document verify endpoint usage
4. Add troubleshooting for common API key issues
5. Update GitHub issue #6 with final status

## Dependency Graph

```
Phase 1 (Backend)
    │
    ├── Phase 2 (shadcn) ─────────────┐
    │                                  │
    │                                  v
    └── Phase 3 (UI) ──────────> Phase 4 (Nav)
                                       │
                                       v
                                 Phase 5 (Tests)
                                       │
                                       v
                                 Phase 6 (Docs)
```

**Critical Path**: Phase 1 → Phase 3 → Phase 5

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| shadcn conflicts with existing styles | Test in isolation first, use CSS modules if needed |
| Better Auth API Key plugin bugs | Pin to 1.4.4, have fallback plan for custom endpoints |
| Database migration issues | Test on dev DB first, have rollback script |
| Performance degradation | Add verification response time monitoring |

## Integration Points

| System | Integration | Notes |
|--------|-------------|-------|
| Better Auth | API Key plugin | Built-in support |
| Neon Postgres | api_key table | New table via migration |
| Admin Dashboard | /admin/service-keys | New route |
| MCP Servers (external) | /api/auth/api-key/verify | Verify endpoint |
| GitHub Actions (external) | x-api-key header | M2M authentication |

## Success Validation

After implementation complete:

1. **Functional**: Admin can create, view, revoke, delete API keys via dashboard
2. **Security**: Keys are hashed, never logged in full, rate limited
3. **Performance**: Verification <100ms p95
4. **Testing**: All tests pass (API + E2E)
5. **Documentation**: Integration guide updated
6. **GitHub**: Issue #6 updated with completion status

## Complexity Tracking

> No constitutional violations requiring justification.

| Aspect | Complexity | Justification |
|--------|------------|---------------|
| New dependency (shadcn) | Low | Standard choice for Next.js admin UIs |
| New database table | Low | Standard Better Auth plugin pattern |
| New admin page | Low | Follows existing admin/* pattern |
